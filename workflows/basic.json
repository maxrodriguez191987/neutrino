{
  "name": "WhatsApp Sales Automation - Limpio y Corregido",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "messages"
        ]
      },
      "id": "whatsapp-trigger",
      "name": "WhatsApp Trigger",
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -4300,
        5200
      ],
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "N0xURK0A24oorQSm",
          "name": "WhatsApp OAuth account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "ton_text",
              "value": "={{ $json.body.entry[0].changes[0].value.messages[0].text.body }}",
              "type": "string"
            },
            {
              "name": "ton_from",
              "value": "={{ $json.body.entry[0].changes[0].value.messages[0].from }}",
              "type": "string"
            },
            {
              "name": "ton_wa_id",
              "value": "={{ $json.body.entry[0].changes[0].value.contacts?.[0]?.wa_id || $json.body.entry[0].changes[0].value.messages[0].from }}",
              "type": "string"
            },
            {
              "name": "ton_timestamp",
              "value": "={{ $json.body.entry[0].changes[0].value.messages[0].timestamp }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "normalize-ton",
      "name": "Normalizar a TON",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -4050,
        5200
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "ton_input",
              "value": "=text:\"{{$json.ton_text}}\"\nfrom:\"{{$json.ton_from}}\"\nwa_id:\"{{$json.ton_wa_id}}\"\ntimestamp:\"{{$json.ton_timestamp}}\"",
              "type": "string"
            }
          ]
        }
      },
      "id": "format-ton",
      "name": "Formatear TON Input",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -3800,
        5200
      ]
    },
    {
      "parameters": {
        "modelId": {
          "value": "gpt-4o-mini",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.ton_input}}",
              "role": "user"
            },
            {
              "content": "Eres un asistente de ventas para WhatsApp. Responde SIEMPRE:\nintent:\"[tipo]\"\nresponse:\"[texto]\"\nTipos: saludo, consulta_producto, precio, otro.",
              "role": "system"
            }
          ]
        },
        "options": {
          "temperature": 0.3
        }
      },
      "id": "openai-intent",
      "name": "OpenAI - Interpretar Intención",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1,
      "position": [
        -3550,
        5200
      ],
      "credentials": {
        "openAiApi": {
          "id": "RJbm0DOTHPeokxil",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "intent",
              "value": "={{ $json.output.match(/intent:\\\"([^\\\"]+)\\\"/)?.[1] || 'otro' }}",
              "type": "string"
            },
            {
              "name": "response",
              "value": "={{ $json.output.match(/response:\\\"([^\\\"]+)\\\"/)?.[1] || 'Lo siento, no pude entenderte.' }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "parse-ton",
      "name": "Parsear Intent y Respuesta",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -3300,
        5200
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{$json.intent}}",
                    "rightValue": "saludo",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{$json.intent}}",
                    "rightValue": "consulta_producto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{$json.intent}}",
                    "rightValue": "precio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{$json.intent}}",
                    "rightValue": "otro",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            }
          ]
        }
      },
      "id": "switch-intent",
      "name": "Switch por Intención",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -3050,
        5200
      ]
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "921340014388774",
        "recipientPhoneNumber": "={{$json.ton_from}}",
        "textBody": "={{$json.response}}",
        "additionalFields": {
          "previewUrl": false
        }
      },
      "id": "send-message",
      "name": "Enviar WhatsApp",
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -2800,
        5200
      ],
      "credentials": {
        "whatsAppApi": {
          "id": "2NabQ060HqIWoqt5",
          "name": "WhatsApp account 2"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"ok\":true}"
      },
      "id": "webhook-response",
      "name": "Responder Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -2550,
        5200
      ]
    }
  ],
  "connections": {
    "whatsapp-trigger": {
      "main": [
        [
          {
            "node": "normalize-ton",
            "type": "main"
          }
        ]
      ]
    },
    "normalize-ton": {
      "main": [
        [
          {
            "node": "format-ton",
            "type": "main"
          }
        ]
      ]
    },
    "format-ton": {
      "main": [
        [
          {
            "node": "openai-intent",
            "type": "main"
          }
        ]
      ]
    },
    "openai-intent": {
      "main": [
        [
          {
            "node": "parse-ton",
            "type": "main"
          }
        ]
      ]
    },
    "parse-ton": {
      "main": [
        [
          {
            "node": "switch-intent",
            "type": "main"
          }
        ]
      ]
    },
    "switch-intent": {
      "main": [
        [
          {
            "node": "send-message",
            "type": "main"
          }
        ]
      ]
    },
    "send-message": {
      "main": [
        [
          {
            "node": "webhook-response",
            "type": "main"
          }
        ]
      ]
    }
  },
  "active": false
}
